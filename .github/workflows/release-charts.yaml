name: Push Charts to helm-charts-registry

on:
  push:
    # branches:
    # - main
    #paths:
    #  - 'charts'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout 
      - name: Checkout
        uses: actions/checkout@v3.3.0
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # 
      # https://github.com/Azure/setup-helm
      # Acceptable values for version are latest or any semantic version string like v2.16.7 Use this action in workflow to define which version of helm will be used.
      #
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 3.5.0 #renovate: datasource=github-releases depName=helm/helm

      - name: Helm Repository Checkout
        uses: actions/checkout@v3.3.0
        with:
          repository: hpi-schul-cloud/helm-charts-registry
          token: ${{ secrets.TOKEN_INVENTORY }}
          fetch-depth: 0
          persist-credentials: true
          ref: main
          path: helm-charts-registry
      - name: Prepare Helm Chart
        run:  |
          # edusharing-crawler
          helm package charts/edusharing-crawler -d helm-charts-registry
          cd helm-charts-registry
          if [ -d "automation/edusharing-crawler" ]; then rm -r automation/edusharing-crawler; fi
          tar -xzf edusharing-crawler*.tgz
          mv edusharing-crawler automation/edusharing-crawler
          cd ..
          # edusharing-setup
          helm package charts/edusharing-setup -d helm-charts-registry
          cd helm-charts-registry
          if [ -d "automation/edusharing-setup" ]; then rm -r automation/edusharing-setup; fi
          tar -xzf edusharing-setup*.tgz
          mv edusharing-setup automation/edusharing-setup
      - name: Push Helm Chart
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_INVENTORY }}
        run: |
          git config --global user.email "oeh-search-etl-gha@dbildungscloud.de"
          git config --global user.name "oeh-search-etl-gha"
          CHART_PACKAGE_NAMES="edusharing-crawler edusharing-setup"
          cd helm-charts-registry/automation
          git add $CHART_PACKAGE_NAMES
          git commit -m $CHART_PACKAGE_NAMES
          git push origin main